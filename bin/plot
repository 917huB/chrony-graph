#!/bin/sh

if [ -d /usr/share/fonts/liberation ]; then
  export GDFONTPATH=/usr/share/fonts/liberation
elif [ -d /usr/share/fonts/truetype/liberation ]; then
  export GDFONTPATH=/usr/share/fonts/truetype/liberation
else
  echo warning: liberation truetype fonts not found
fi
export GNUPLOT_DEFAULT_GDFONT=LiberationSans-Regular

../bin/local-clock-graph
../bin/offset-graph
../bin/skew-graph

NINETYFIVE=`../bin/percentile 2 95 loopstats`
NINETYNINE=`../bin/percentile 2 99 loopstats`
FIVE=`../bin/percentile 2 5 loopstats`
ONE=`../bin/percentile 2 1 loopstats`
NF_M_F=`echo $NINETYFIVE - $FIVE | bc`
NN_M_O=`echo $NINETYNINE - $ONE | bc`
gnuplot <<EOF
set terminal png size 900,600
set xdata time
set timefmt "%s"
set output "percentiles.png"
set grid
set xlabel "Time"
set format x "%d-%H:%M"
set xtic rotate by -45 scale 0
set ytics format "%1.3f ppm" nomirror
set title "Local Clock Frequency Offset"
set key bottom right box
set style line 1 lc rgb '#0060ad' lt 1 lw 1 pt 7 ps 0   # --- blue
set style line 2 lc rgb '#dd181f' lt 1 lw 1 pt 5 ps 0   # --- red
set label 1 gprintf("99%% = $NINETYNINE ppm",99) at graph 0.01,0.3 left front
set label 2 gprintf("95%% = $NINETYFIVE ppm",95) at graph 0.01,0.25 left front
set label 3 gprintf(" 5%% = $FIVE ppm",5) at graph 0.01,0.2 left front
set label 4 gprintf(" 1%% = $ONE ppm",1) at graph 0.01,0.15 left front
set label 5 gprintf("95%% - 5%% = $NF_M_F ppm",90) at graph 0.01,0.1 left front
set label 6 gprintf("99%% - 1%% = $NN_M_O ppm",98) at graph 0.01,0.05 left front
set lmargin 12
set rmargin 12
plot \
 "loopstats" using 1:3 title "local clock error" with linespoints ls 2, \
 $NINETYNINE title "99th percentile", \
 $NINETYFIVE title "95th percentile", \
 $FIVE title "5th percentile", \
 $ONE title "1st percentile"
EOF

NINETYFIVE=`../bin/percentile 1 95 loopstats | ../bin/mul 1000000`
NINETYNINE=`../bin/percentile 1 99 loopstats | ../bin/mul 1000000`
FIVE=`../bin/percentile 1 5 loopstats | ../bin/mul 1000000`
ONE=`../bin/percentile 1 1 loopstats | ../bin/mul 1000000`
NF_M_F=`echo $NINETYFIVE - $FIVE | bc`
NN_M_O=`echo $NINETYNINE - $ONE | bc`
gnuplot <<EOF
set terminal png size 900,600
set xdata time
set timefmt "%s"
set output "percentiles-offset.png"
set grid
set xlabel "Time"
set format x "%d-%H:%M"
set xtic rotate by -45 scale 0
set ytics format "%1.2f us" nomirror
set title "Local Clock Time Offset"
set key bottom right box
set style line 1 lc rgb '#0060ad' lt 1 lw 1 pt 7 ps 0   # --- blue
set style line 2 lc rgb '#dd181f' lt 1 lw 1 pt 5 ps 0   # --- red
set label 1 gprintf("99%% = %1.2f us",$NINETYNINE) at graph 0.01,0.3 left front
set label 2 gprintf("95%% = %1.2f us",$NINETYFIVE) at graph 0.01,0.25 left front
set label 3 gprintf(" 5%% = %1.2f us",$FIVE) at graph 0.01,0.2 left front
set label 4 gprintf(" 1%% = %1.2f us",$ONE) at graph 0.01,0.15 left front
set label 5 gprintf("95%% - 5%% = %1.2f us", $NF_M_F) at graph 0.01,0.1 left front
set label 6 gprintf("99%% - 1%% = %1.2f us", $NN_M_O) at graph 0.01,0.05 left front
set lmargin 12
set rmargin 12
plot \
 "loopstats" using 1:(\$2 * 1000000) title "local clock offset" with linespoints ls 1, \
 $NINETYNINE title "99th percentile", \
 $NINETYFIVE title "95th percentile", \
 $FIVE title "5th percentile", \
 $ONE title "1st percentile"
EOF

# for nanosecond level:
../bin/histogram 1 100000000 <loopstats >loopstats.history
# microseconds:
#../bin/histogram 1 1000000 <loopstats >loopstats.history
SEVENTYFIVE=`../bin/percentile 1 75 loopstats | ../bin/mul 1000000`
TWENTYFIVE=`../bin/percentile 1 25 loopstats | ../bin/mul 1000000`

gnuplot <<EOF
set terminal png size 900,600
set output "offset-histogram.png"
set grid
set xtic rotate by -45 scale 0
set title "Local Clock Time Offset - Histogram"
set xtics format "%1.1f us" nomirror
set label 1 gprintf("99%% = %1.2f us",$NINETYNINE) at $NINETYNINE, graph 0.91 left front offset 1,-1
set style arrow 1 nohead 
set arrow from $NINETYNINE,0 to $NINETYNINE,graph 0.91 as 1
set label 2 gprintf(" 1%% = %1.2f us",$ONE) at $ONE, graph 0.91 right front offset -1,-1
set style arrow 2 nohead
set arrow from $ONE,0 to $ONE,graph 0.91 as 2
set label 3 gprintf("25%% = %1.2f us",$TWENTYFIVE) at $TWENTYFIVE, graph 0.7 right front offset -1,-1
set style arrow 3 nohead
set arrow from $TWENTYFIVE,0 to $TWENTYFIVE,graph 0.7 as 3
set label 4 gprintf("75%% = %1.2f us",$SEVENTYFIVE) at $SEVENTYFIVE, graph 0.7 left front offset 1,-1
set style arrow 4 nohead
set arrow from $SEVENTYFIVE,0 to $SEVENTYFIVE,graph 0.7 as 4
set key off
set lmargin 12
set rmargin 12
set xrange [-20:20]
plot \
 "loopstats.history" using (\$1/100):2 title "histogram" with boxes
EOF

# optional GPS tracking
if [ -f gps-lock -a -f snr-history -a \! -f disable-default-gps-graphs ]; then
  gnuplot <<EOF
  set terminal png size 900,600
  set xdata time
  set timefmt "%s"
  set output "gps-lock.png"
  set grid
  set xlabel "Time"
  set format x "%d-%H:%M"
  set xtic rotate by -45 scale 0
  set ytics format "%1.0f %%" nomirror
  set title "% of time spent in GPS lock"
  set key bottom right box
  plot \
   "gps-lock" using 1:(\$2/(\$2+\$3)*100) title "lock" with lines
EOF

  ../bin/snr-hourly snr-history >snr-history.hourly
  gnuplot <<EOF
  set terminal png size 900,600
  set xdata time
  set timefmt "%s"
  set output "gps-snr-hourly.png"
  set grid
  set xlabel "Time"
  set format x "%d-%H:%M"
  set xtic rotate by -45 scale 0
  set ytics format "%1.0f %% of time" nomirror
  set title "Percent of time satellites spent at 0 snr"
  set key bottom right box
  plot \
   "snr-history.hourly" using 1:(\$2 / (\$2 + \$3) * 100) title "signal" with lines
EOF

  ../bin/histogram-snr --cdf <snr-history >snr-history.cdf
  gnuplot <<EOF
  set terminal png size 900,600
  set output "gps-snr-cdf.png"
  set grid
  set xtic rotate by -45 scale 0
  set title "GPS SNR cdf"
  set xtics format "%1.1fdB snr" nomirror
  set ytics format "%1.0f %%" nomirror
  set key bottom right box
  plot \
   "snr-history.cdf" using 1:2 title "GPS" with lines
EOF
fi

if [ -x custom-plot ]; then
  ./custom-plot
fi

../bin/copy-to-website
